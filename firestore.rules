rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =============================================
    // FUNÇÕES AUXILIARES
    // =============================================
    
    // Verifica se o usuário está autenticado
    function isAuth() {
      return request.auth != null;
    }
    
    // Verifica se o usuário é admin autorizado
    function isAdmin() {
      return isAuth() && 
        exists(/databases/$(database)/documents/authorizedUsers/$(request.auth.token.email));
    }

    // =============================================
    // COLLECTIONS PÚBLICAS (leitura aberta)
    // =============================================

    // Pacotes turísticos - leitura pública, escrita somente admin
    match /pacotes/{pacoteId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Banners do carrossel - leitura pública, escrita somente admin
    match /banners/{bannerId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Blog posts - leitura pública, escrita somente admin
    match /blogPosts/{postId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Avaliações/Reviews - leitura pública, escrita somente admin
    match /avaliacoes/{avaliacaoId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // =============================================
    // COLLECTIONS COM ACESSO RESTRITO
    // =============================================

    // Reservas - clientes autenticados podem criar; admin pode tudo; 
    // cliente pode ler apenas as próprias reservas
    match /reservas/{reservaId} {
      allow create: if true;
      allow read: if isAdmin() || 
        (isAuth() && resource.data.userId == request.auth.uid) ||
        (isAuth() && resource.data.email == request.auth.token.email);
      allow update, delete: if isAdmin();
    }

    // Viagens - somente admin pode ler e escrever
    match /viagens/{viagemId} {
      allow read, write: if isAdmin();
    }

    // Motoristas - somente admin pode ler e escrever
    match /motoristas/{motoristaId} {
      allow read, write: if isAdmin();
    }

    // Usuários autorizados (admin) - leitura pública (necessário para validar login)
    // Escrita somente admin
    match /authorizedUsers/{userId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Analytics - leitura admin, escrita por qualquer visitante (para rastreamento)
    match /analytics/{docId} {
      allow read: if isAdmin();
      allow create, update: if true;
      allow delete: if isAdmin();
    }

    // Usuários registrados - cada usuário lê/escreve apenas seus dados
    match /users/{uid} {
      allow read, write: if isAuth() && request.auth.uid == uid;
      allow read: if isAdmin();
    }

    // Settings do sistema - somente admin
    match /settings/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // Content (conteúdo do site) - leitura pública, escrita admin
    match /content/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Servicos (home) - leitura pública, escrita admin
    match /servicos/{servicoId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // =============================================
    // FALLBACK - Negar tudo que não foi explicitamente permitido
    // =============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
